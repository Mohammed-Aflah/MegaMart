<%-include('../partials/header.ejs') %>
    <div class="signup">
        <%-include('../partials/profiletoggle.ejs')%>
        <div class="checkout">
            <div class="heading">
                <h1>Billing Details</h1>
            </div>
            <form class="checkandAddress"  id="checkoutform1" onsubmit="checkoutWithAddress(event,'<%-id%>')">
                <div class="checkoutform">
                    <div class="controller">
                        <label for="name">name</label>
                        <input required type="text" name="name" id="name">
                    </div>
                    <div class="controller">
                        <label for="email">email</label>
                        <input required type="email" name="email" id="email">
                    </div>
                    <div class="controller">
                        <label for="state">state</label>
                        <input required type="text" name="state" id="state">
                    </div>
                    <div class="controller">
                        <label for="district">district</label>
                        <input required type="text" name="district" id="district">
                    </div>
                    <div class="controller">
                        <label for="pincode">pincode</label>
                        <input required type="text" name="pincode" id="pincode">
                    </div>
                    <div class="controller">
                        <label for="street">street</label>
                        <input required type="text" name="street" id="street">
                    </div>
                    <div class="controller">
                        <label for="phone">phone</label>
                        <input required type="text" name="phone"  id="phone">
                    </div>
                    <div class="controller">
                        <label for="apar">Apartment, floor, etc. (optional)</label>
                        <input required type="text" name="apartment" id="apar">
                    </div>
                </div>
                <div class="checkoutbox">
                    <div class="item_box">
                        <%userCartdata.forEach((data)=>{%>
                            <div class="priceandimg">
                                <div class="img" qty="<%-data.products.qty%>">
                                    <img src="/product-images/<%-data.cartData.image[0].mainimage%>" width="40px" height="auto" alt="">
                                </div>
                                <div class="name"><%-data.cartData.productName%></div>
                                <div class="price">₹<%-data.cartData.discount*data.products.qty%></div>
                            </div>
                      <%  })%>
                        <div class="priceandimg sub">
                            <div class="name" >Subtotal  </div>
                            <div class="price">₹<%-totalAmount%></div>
                        </div>
                        <div class="priceandimg sub">
                            <div class="name" >Shipping  </div>
                            <div class="price">Free</div>
                        </div>
                        <div class="priceandimg sub total">
                            <div class="name" >Total  </div>
                            <div class="price">₹<%-totalAmount%></div>
                        </div>
                        <div class="priceandimg select">
                            <div class="radio">
                                <div class="btn">
                                    <input type="radio" name="payment_method" value="Bank" id="">
                                </div>
                                <p>Bank</p>
                            </div>
                            <div class="imgs">
                                <img src="/images/fstBkash.svg" alt="">
                                <img src="/images/visacard.svg" alt="">
                                <img src="/images/Mastercard.svg" alt="">
                                <img src="/images/hndi.svg" alt="">
                            </div>
                        </div>
                        <div class="priceandimg select">
                            <div class="radio">
                                <div class="btn">
                                    <input type="radio" name="payment_method" value="COD" id="">
                                </div>
                                <p>Cash on delivery</p>
                            </div>
                            
                        </div>
                        <div class="priceandimg select button">
                            <button type="submit">Place Order</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    </div>    
    <script>
        //name,
        //email,
        //state,
        //district,
        //pincode,
        //street,
        //phone,
        //apartment,
        //payment_method,
        function checkoutWithAddress(event, userId) {
            const checkoutFormForAddress = document.getElementById("checkoutform1");
            const name=document.getElementById("name")
            const email=document.getElementById("email")
            const state=document.getElementById("state")
            const district=document.getElementById("district")
            const pincode=document.getElementById("pincode")
            const street=document.getElementById("street")
            const phone=document.getElementById("phone")
            const apartment=document.getElementById("apar")
            const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked')
            event.preventDefault();
            //let val = document.getElementById("name");
            let formData = {
                name:name.value,
                email:email.value,
                state:state.value,
                district:district.value,
                pincode:pincode.value,
                street:street.value,
                phone:phone.value,
                apartment:apartment.value,
                payment_method:selectedPaymentMethod.value
            };
            
            fetch(`http://localhost:5001/users/product/checkout/address/${userId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
            },
              body: JSON.stringify(formData), // Use formData, not new FormData(checkoutFormForAddress)
            })
              .then((response) => response.json())
              .then((res) => {
                
                console.log(res.status + ' -______- status');
                if (res.status === 'COD') {
                  location.href = `/users/product/checkout/payment/success/${userId}`;
                }else{
                    razorpayPayment(res,userId)
                }
              })
              //.catch((err)=>{
              //  alert('error is'+err)
              //});
          }
          function razorpayPayment(order,userId){
            
            let options={
                key:'rzp_test_2kq1q9uS7VLUsv',
                amount:order.amount,
                currency:'INR',
                order_id:order.order_id,
                handler:(response)=>{
                    console.log(response)
                    if(response.razorpay_payment_id){
                        window.location.href=`http://localhost:5001/users/product/checkout/payment/success/${userId}`
                    }
                }
            } 
            const rzp=new Razorpay(options);
            rzp.open()
          }
      </script>
      
    <%-include('../partials/footer.ejs') %>

